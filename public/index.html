<!DOCTYPE html>
<html>

<head>
    <title>RSC Globe 1</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            background: #000;
            color: #fff;
            font-family: Arial;
            overflow: hidden
        }

        #game-container {
            width: 512px;
            height: 346px;
            margin: 20px auto
        }

        #mudclient-canvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            background: #000
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000
        }

        #loading h1 {
            color: #ffcc00;
            margin-bottom: 20px
        }

        #loading p {
            color: #ccc;
            margin: 5px 0
        }

        .hidden {
            display: none !important
        }

        #gdpr {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a1a;
            border-top: 2px solid #ffcc00;
            padding: 15px;
            z-index: 9999;
            display: none
        }

        #gdpr p {
            margin: 0 0 10px;
            font-size: 14px
        }

        #gdpr button {
            background: #ffcc00;
            color: #000;
            border: none;
            padding: 8px 20px;
            cursor: pointer;
            border-radius: 4px
        }
    </style>
</head>

<body>
    <div id="loading">
        <h1>üåç RSC Globe 1</h1>
        <p>Loading RuneScape Classic...</p>
        <p><em>KV Persistence + Auto-Save</em></p>
    </div>
    <div id="game-container">
        <canvas id="mudclient-canvas" width="512" height="346"></canvas>
        <!DOCTYPE html>
        <html>

        <head>
            <title>RSC Globe 1</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box
                }

                body {
                    background: #000;
                    color: #fff;
                    font-family: Arial;
                    overflow: hidden
                }

                #game-container {
                    width: 512px;
                    height: 346px;
                    margin: 20px auto
                }

                #mudclient-canvas {
                    display: block;
                    width: 100%;
                    height: 100%;
                    image-rendering: pixelated;
                    background: #000
                }

                #loading {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: #000;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000
                }

                #loading h1 {
                    color: #ffcc00;
                    margin-bottom: 20px
                }

                #loading p {
                    color: #ccc;
                    margin: 5px 0
                }

                .hidden {
                    display: none !important
                }

                #gdpr {
                    position: fixed;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    background: #1a1a1a;
                    border-top: 2px solid #ffcc00;
                    padding: 15px;
                    z-index: 9999;
                    display: none
                }

                #gdpr p {
                    margin: 0 0 10px;
                    font-size: 14px
                }

                #gdpr button {
                    background: #ffcc00;
                    color: #000;
                    border: none;
                    padding: 8px 20px;
                    cursor: pointer;
                    border-radius: 4px
                }
            </style>
        </head>

        <body>
            <div id="loading">
                <h1>üåç RSC Globe 1</h1>
                <p>Loading RuneScape Classic...</p>
                <p><em>KV Persistence + Auto-Save</em></p>
            </div>
            <div id="game-container">
                <canvas id="mudclient-canvas" width="512" height="346"></canvas>
            </div>
            <div id="gdpr">
                <p>üç™ We use Cloudflare KV to store your game progress. By playing, you consent to this storage.</p>
                <button
                    onclick="document.getElementById('gdpr').style.display='none';localStorage.setItem('gdpr','1')">Accept</button>
            </div>
            <script>
                if (!localStorage.getItem('gdpr')) document.getElementById('gdpr').style.display = 'block';

                // --- PROTOTYPE HOOK TO CAPTURE MUDCLIENT INSTANCE ---
                // This is a workaround because the bundle doesn't expose mudclient globally.
                // We hook into a property we know the client sets early on: 'localRegionX'.
                (function () {
                    var originalLocalRegionX;
                    Object.defineProperty(Object.prototype, 'localRegionX', {
                        set: function (value) {
                            // Capture the instance if it looks like the mudclient (has 'loginUser' or similar)
                            // or just capture the first object setting this property if we are sure it's the client.
                            // The client sets localRegionX in the packet handler, but also potentially elsewhere.
                            // Let's check for a known method or property to be safe, or just capture 'this'.

                            // In the minified code, 'this' when setting localRegionX should be the client instance.
                            if (!window.mudclientInstance && this.loginUser !== undefined) {
                                console.log('üé£ Captured mudclient instance via prototype hook!', this);
                                window.mudclientInstance = this;

                                // Initialize the server worker and attach it
                                const w = new Worker('./rsc-server.js');
                                console.log('‚úÖ Server Worker initialized (hook)');
                                this.server = w;
                                this.members = true;
                                this.threadSleep = 10;

                                // Setup Auto-Save now that we have the instance
                                setupAutoSave(this);

                                // Move the canvas created by the bundle to our container
                                // The bundle creates a div and appends it to body. We want the canvas in #game-container.
                                setTimeout(() => {
                                    const generatedCanvas = document.querySelector('canvas');
                                    const container = document.getElementById('game-container');
                                    if (generatedCanvas && container && generatedCanvas.parentNode !== container) {
                                        container.innerHTML = ''; // Clear our placeholder
                                        container.appendChild(generatedCanvas);
                                        generatedCanvas.style.width = '100%';
                                        generatedCanvas.style.height = '100%';
                                        console.log('‚úÖ Moved generated canvas to game container');
                                    }
                                    document.getElementById('loading').classList.add('hidden');
                                }, 1000);
                            }

                            // Store the value in a hidden property so the game still works
                            this._localRegionX = value;
                        },
                        get: function () {
                            return this._localRegionX;
                        },
                        configurable: true // Allow re-definition if needed (though we probably won't)
                    });
                })();
                // ----------------------------------------------------

                _API = {
                    async savePlayer(p) { try { return await (await fetch('/api/player/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(p) })).json() } catch (e) { return { success: false, error: e.message } } },
                    async loadPlayer(u) { try { return await (await fetch(`/api/player/load?username=${encodeURIComponent(u)}`)).json() } catch (e) { return { success: false, error: e.message } } },
                    async login(u, p) { try { return await (await fetch('/api/player/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: u, password: p }) })).json() } catch (e) { return { success: false, error: e.message } } },
                    async register(p) { try { return await (await fetch('/api/player/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(p) })).json() } catch (e) { return { success: false, error: e.message } } }
                };

                let autoSaveInterval, lastSave = 0;
                function setupAutoSave(mc) {
                    const save = async (u) => { try { const n = Date.now(); if (!u && n - lastSave < 5000) return; const d = { username: mc.loginUser, password: mc.loginPass, x: mc.localPlayer.currentX, y: mc.localPlayer.currentY, skills: mc.playerStatCurrent, experience: mc.playerExperience, inventory: mc.inventoryItemId.slice(0, mc.inventoryItemsCount), inventoryCount: mc.inventoryItemStackCount.slice(0, mc.inventoryItemsCount), questsComplete: mc.questComplete, questPoints: mc.playerQuestPoints, soundOn: mc.optionSoundDisabled ? 0 : 1, lastSaved: n, loginDate: mc.welcomeLastLoggedInDays || 0 }; const r = await window.RSC_KV_API.savePlayer(d); if (r.success) { lastSave = n; if (!u) console.log('üíæ Auto-saved') } else console.error('Save failed:', r.error) } catch (e) { console.error('Save error:', e) } };
                    autoSaveInterval = setInterval(() => { if (mc.loggedIn === 1 && mc.localPlayer) save() }, 30000);
                    window.addEventListener('beforeunload', () => { if (mc.loggedIn === 1 && mc.localPlayer) save(true) });
                    document.addEventListener('visibilitychange', () => { if (document.hidden && mc.loggedIn === 1 && mc.localPlayer) save() });
                    console.log('‚úÖ Auto-Save: ACTIVE');
                }

                async function initClient() {
                    try {
                        // We no longer instantiate mudclient here because the bundle does it.
                        // We just load the script and let the hook catch the instance.
                        const s = document.createElement('script');
                        s.src = './rsc-client/index.bundle.min.js';
                        s.onload = async () => {
                            console.log('‚úÖ Client script loaded');
                            // The hook in the IIFE above will handle the rest when the client initializes.
                        };
                        s.onerror = () => document.getElementById('loading').innerHTML = '<h1 style="color:#f00">Error Loading Client</h1>';
                        document.head.appendChild(s);
                    } catch (e) {
                        console.error('Init error:', e);
                        document.getElementById('loading').innerHTML = `<h1 style="color:#f00">Error</h1><p>${e.message}</p>`;
                    }
                }
                initClient();
            </script>
        </body>

        </html>